name: shopflow-API-Deployment

on:
  push:
    branches: ["main"]
    paths:
      - 'apps/api/**'
      - '.github/workflows/deploy-api.yml'

jobs:
  test:
    name: Test shopflow-api
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build application
        run: pnpm --filter api run build

  deploy:
    name: Build and Deploy to EC2
    needs: test
    runs-on: self-hosted
    
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Build Docker image with cache
        run: |
          cd apps/api
          docker build \
            --cache-from shopflow-api:latest \
            -f Dockerfile \
            -t shopflow-api:${{ github.sha }} \
            -t shopflow-api:latest \
            ../../

      - name: Import image to k3s
        run: |
          docker save shopflow-api:${{ github.sha }} | sudo k3s ctr images import -

      - name: Create namespace
        run: |
          kubectl create namespace shopflow --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply RBAC
        run: |
          kubectl apply -f k8s/rbac.yaml

      - name: Update secrets
        run: |
          kubectl delete secret api-secrets -n shopflow --ignore-not-found=true
          kubectl create secret generic api-secrets \
            --from-env-file=<(echo "${{ secrets.PROD_ENV }}") \
            --namespace=shopflow

      - name: Update deployment manifest with image tag
        run: |
          sed -i "s|image: shopflow-api:latest|image: shopflow-api:${{ github.sha }}|g" k8s/api-deployment.yaml

      - name: Deploy to k3s
        run: |
          kubectl apply -f k8s/api-deployment.yaml

      - name: Wait for deployment
        run: |
          kubectl rollout status deployment/shopflow-api -n shopflow --timeout=120s

      - name: Get service info
        run: |
          kubectl get svc -n shopflow shopflow-api
          echo "API accessible at: http://$(curl -s ifconfig.me):30001"

      - name: Health check
        run: |
          sleep 10
          curl -f http://localhost:30001/health || exit 1

      - name: Cleanup old Docker images
        if: success()
        run: |
          echo "ðŸ§¹ Cleaning up old Docker images..."
          docker image prune -af --filter "until=24h"
          echo "âœ… Cleanup complete!"

      - name: Deployment success
        run: |
          echo "âœ… Deployment successful!"
          echo "ðŸš€ API is running in k3s"
          echo "ðŸŒ Access at: http://$(curl -s ifconfig.me):30001"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          kubectl logs -n shopflow -l app=shopflow-api --tail=50