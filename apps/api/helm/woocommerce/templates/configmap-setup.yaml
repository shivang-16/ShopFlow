apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-setup-script
  labels:
    app: {{ .Release.Name }}-wordpress
data:
  setup.sh: |
    #!/bin/bash
    
    # Wait for WordPress to be ready
    echo "Waiting for WordPress..."
    until $(curl --output /dev/null --silent --head --fail http://localhost:80); do
        printf '.'
        sleep 5
    done
    
    echo "WordPress is up. Installing WP-CLI..."
    
    # Install dependencies
    apt-get update && apt-get install -y unzip less
    
    # Install WP-CLI
    curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
    chmod +x wp-cli.phar
    mv wp-cli.phar /usr/local/bin/wp
    
    # Wait for database connection and installation
    echo "Waiting for WordPress installation..."
    until wp core is-installed --allow-root --path=/var/www/html; do
        sleep 5
        # Try to install if not installed (though the docker image should handle this)
        # But usually we just wait
        echo "Waiting for core install..."
    done
    
    echo "WordPress Core is ready. Installing WooCommerce..."
    
    # Install and activate WooCommerce
    wp plugin install woocommerce --activate --allow-root --path=/var/www/html
    
    # Install and activate Storefront theme
    echo "Installing Storefront theme..."
    wp theme install storefront --activate --allow-root --path=/var/www/html
    
    # Create default shop pages
    echo "Creating shop pages..."
    wp wc tool run install_pages --user=1 --allow-root --path=/var/www/html
    
    echo "Setup complete!"
