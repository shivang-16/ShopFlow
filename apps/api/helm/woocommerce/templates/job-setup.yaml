apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-setup
  labels:
    app: {{ .Release.Name }}-wordpress
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: {{ .Release.Name }}-setup-job
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsUser: 0
        runAsGroup: 0
      containers:
      - name: setup
        image: wordpress:cli-php8.1
        command: ["/bin/sh"]
        args:
          - -c
          - |
            set -e
            
            echo "Installing dependencies..."
            apk add --no-cache curl
            
            echo "Waiting for WordPress and Database to be ready..."
            
            # Wait for WordPress service to be accessible
            sleep 30
            
            # Try to connect to WordPress
            RETRIES=0
            MAX_RETRIES=30
            until curl -sf http://{{ .Release.Name }}-wordpress/wp-admin/install.php > /dev/null 2>&1 || [ $RETRIES -eq $MAX_RETRIES ]; do
              echo "Waiting for WordPress... (attempt $RETRIES/$MAX_RETRIES)"
              sleep 10
              RETRIES=$((RETRIES+1))
            done
            
            if [ $RETRIES -eq $MAX_RETRIES ]; then
              echo "ERROR: WordPress did not become ready in time"
              exit 1
            fi
            
            echo "WordPress is accessible. Starting setup..."
            
            # Check if already set up
            if wp core is-installed --path=/var/www/html --allow-root 2>/dev/null; then
              echo "WordPress already installed. Checking plugins..."
              
              if wp plugin is-installed woocommerce --path=/var/www/html --allow-root 2>/dev/null; then
                echo "WooCommerce already installed. Skipping setup."
                exit 0
              fi
            else
              echo "Installing WordPress..."
              wp core install \
                --url="{{ .Values.wordpress.siteUrl }}" \
                --title="ShopFlow Store" \
                --admin_user="admin" \
                --admin_password="{{ .Values.wordpress.adminPassword }}" \
                --admin_email="admin@example.com" \
                --path=/var/www/html \
                --allow-root
            fi
            
            echo "Installing WooCommerce..."
            wp plugin install woocommerce --activate --path=/var/www/html --allow-root
            
            echo "Installing Storefront theme..."
            wp theme install storefront --activate --path=/var/www/html --allow-root
            
            echo "Creating WooCommerce pages..."
            wp wc tool run install_pages --user=1 --path=/var/www/html --allow-root || true
            
            echo "Enabling Cash on Delivery..."
            wp option patch update woocommerce_cod_settings enabled yes --path=/var/www/html --allow-root || true
            
            echo "Creating sample products..."
            
            echo "Downloading sample images..."
            curl -o /tmp/headphones.jpg https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=800 || true
            curl -o /tmp/tshirt.jpg https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=800 || true
            curl -o /tmp/bottle.jpg https://images.unsplash.com/photo-1602143407151-7111542de6e8?w=800 || true
            curl -o /tmp/yoga.jpg https://images.unsplash.com/photo-1601925260368-ae2f83cf8b7f?w=800 || true
            curl -o /tmp/tracker.jpg https://images.unsplash.com/photo-1575311373937-040b8e1fd5b6?w=800 || true
            
            # Product 1: Premium Wireless Headphones
            PRODUCT_ID_1=$(wp post create --post_type=product --post_title='Premium Wireless Headphones' --post_status=publish --post_content='High-quality wireless headphones with noise cancellation, 30-hour battery life, and premium sound quality. Perfect for music lovers and professionals.' --path=/var/www/html --allow-root --porcelain)
            wp post meta add $PRODUCT_ID_1 _regular_price 149.99 --path=/var/www/html --allow-root
            wp post meta add $PRODUCT_ID_1 _price 149.99 --path=/var/www/html --allow-root
            wp post meta add $PRODUCT_ID_1 _manage_stock no --path=/var/www/html --allow-root
            wp post meta add $PRODUCT_ID_1 _stock_status instock --path=/var/www/html --allow-root
            if [ -f /tmp/headphones.jpg ]; then
              IMG_ID_1=$(wp media import /tmp/headphones.jpg --post_id=$PRODUCT_ID_1 --title='Headphones' --path=/var/www/html --allow-root --porcelain)
              wp post meta add $PRODUCT_ID_1 _thumbnail_id $IMG_ID_1 --path=/var/www/html --allow-root
            fi
            
            # Product 2: Classic Cotton T-Shirt
            PRODUCT_ID_2=$(wp post create --post_type=product --post_title='Classic Cotton T-Shirt' --post_status=publish --post_content='Comfortable 100% cotton t-shirt. Available in multiple colors. Perfect for everyday wear.' --path=/var/www/html --allow-root --porcelain)
            wp post meta add $PRODUCT_ID_2 _regular_price 24.99 --path=/var/www/html --allow-root
            wp post meta add $PRODUCT_ID_2 _price 24.99 --path=/var/www/html --allow-root
            wp post meta add $PRODUCT_ID_2 _manage_stock no --path=/var/www/html --allow-root
            wp post meta add $PRODUCT_ID_2 _stock_status instock --path=/var/www/html --allow-root
            if [ -f /tmp/tshirt.jpg ]; then
              IMG_ID_2=$(wp media import /tmp/tshirt.jpg --post_id=$PRODUCT_ID_2 --title='T-Shirt' --path=/var/www/html --allow-root --porcelain)
              wp post meta add $PRODUCT_ID_2 _thumbnail_id $IMG_ID_2 --path=/var/www/html --allow-root
            fi
            
            # Product 3: Stainless Steel Water Bottle
            PRODUCT_ID_3=$(wp post create --post_type=product --post_title='Stainless Steel Water Bottle' --post_status=publish --post_content='Eco-friendly insulated water bottle. Keeps drinks cold for 24 hours or hot for 12 hours. BPA-free and leak-proof.' --path=/var/www/html --allow-root --porcelain)
            wp post meta add $PRODUCT_ID_3 _regular_price 34.99 --path=/var/www/html --allow-root
            wp post meta add $PRODUCT_ID_3 _price 34.99 --path=/var/www/html --allow-root
            wp post meta add $PRODUCT_ID_3 _manage_stock no --path=/var/www/html --allow-root
            wp post meta add $PRODUCT_ID_3 _stock_status instock --path=/var/www/html --allow-root
            if [ -f /tmp/bottle.jpg ]; then
              IMG_ID_3=$(wp media import /tmp/bottle.jpg --post_id=$PRODUCT_ID_3 --title='Water Bottle' --path=/var/www/html --allow-root --porcelain)
              wp post meta add $PRODUCT_ID_3 _thumbnail_id $IMG_ID_3 --path=/var/www/html --allow-root
            fi
            
            # Product 4: Professional Yoga Mat
            PRODUCT_ID_4=$(wp post create --post_type=product --post_title='Professional Yoga Mat' --post_status=publish --post_content='Non-slip yoga mat with extra cushioning. Perfect for yoga, pilates, and floor exercises. Includes carrying strap.' --path=/var/www/html --allow-root --porcelain)
            wp post meta add $PRODUCT_ID_4 _regular_price 49.99 --path=/var/www/html --allow-root
            wp post meta add $PRODUCT_ID_4 _price 49.99 --path=/var/www/html --allow-root
            wp post meta add $PRODUCT_ID_4 _manage_stock no --path=/var/www/html --allow-root
            wp post meta add $PRODUCT_ID_4 _stock_status instock --path=/var/www/html --allow-root
            if [ -f /tmp/yoga.jpg ]; then
              IMG_ID_4=$(wp media import /tmp/yoga.jpg --post_id=$PRODUCT_ID_4 --title='Yoga Mat' --path=/var/www/html --allow-root --porcelain)
              wp post meta add $PRODUCT_ID_4 _thumbnail_id $IMG_ID_4 --path=/var/www/html --allow-root
            fi
            
            # Product 5: Smart Fitness Tracker
            PRODUCT_ID_5=$(wp post create --post_type=product --post_title='Smart Fitness Tracker' --post_status=publish --post_content='Track your fitness goals with this smart fitness tracker. Features heart rate monitoring, step counting, and sleep tracking.' --path=/var/www/html --allow-root --porcelain)
            wp post meta add $PRODUCT_ID_5 _regular_price 89.99 --path=/var/www/html --allow-root
            wp post meta add $PRODUCT_ID_5 _price 89.99 --path=/var/www/html --allow-root
            wp post meta add $PRODUCT_ID_5 _manage_stock no --path=/var/www/html --allow-root
            wp post meta add $PRODUCT_ID_5 _stock_status instock --path=/var/www/html --allow-root
            if [ -f /tmp/tracker.jpg ]; then
              IMG_ID_5=$(wp media import /tmp/tracker.jpg --post_id=$PRODUCT_ID_5 --title='Fitness Tracker' --path=/var/www/html --allow-root --porcelain)
              wp post meta add $PRODUCT_ID_5 _thumbnail_id $IMG_ID_5 --path=/var/www/html --allow-root
            fi
            
            echo "Creating blog posts..."
            
            # Welcome post
            wp post create \
              --post_type=post \
              --post_title='Welcome to Our Store!' \
              --post_content='<p>We are excited to announce the launch of our new online store! Browse our carefully curated collection of high-quality products designed to enhance your lifestyle.</p><p>From premium electronics to everyday essentials, we have something for everyone. All products come with free shipping on orders over $50 and a 30-day money-back guarantee.</p><p>Thank you for choosing us as your trusted shopping destination!</p>' \
              --post_status=publish \
              --path=/var/www/html \
              --allow-root
            
            # About the store post
            wp post create \
              --post_type=post \
              --post_title='About Our Mission' \
              --post_content='<p>At ShopFlow Store, our mission is to provide high-quality products at affordable prices. We believe in sustainable shopping and ethical sourcing.</p><p>Every product in our catalog is carefully selected to meet our strict quality standards. We partner with trusted manufacturers and suppliers to ensure you receive the best value.</p><p>Customer satisfaction is our top priority. Our dedicated support team is always here to help you with any questions or concerns.</p>' \
              --post_status=publish \
              --path=/var/www/html \
              --allow-root
            
            # Special offers post
            wp post create \
              --post_type=post \
              --post_title='Special Launch Offers' \
              --post_content='<p>To celebrate our launch, we are offering special discounts on selected items!</p><ul><li>Free shipping on all orders over $50</li><li>10% off your first purchase with code: WELCOME10</li><li>Extended 60-day return policy for launch week</li></ul><p>These offers are available for a limited time only. Shop now and enjoy amazing savings!</p>' \
              --post_status=publish \
              --path=/var/www/html \
              --allow-root
            
            echo "Setup complete! ðŸŽ‰"
            echo "Login: admin / {{ .Values.wordpress.adminPassword }}"
        env:
        - name: WORDPRESS_DB_HOST
          value: {{ .Release.Name }}-mariadb
        - name: WORDPRESS_DB_NAME
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-db-secret
              key: mariadb-database
        - name: WORDPRESS_DB_USER
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-db-secret
              key: mariadb-user
        - name: WORDPRESS_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-db-secret
              key: mariadb-password
        volumeMounts:
        - name: wordpress-data
          mountPath: /var/www/html
      volumes:
      - name: wordpress-data
        persistentVolumeClaim:
          claimName: {{ .Release.Name }}-wordpress-pvc
