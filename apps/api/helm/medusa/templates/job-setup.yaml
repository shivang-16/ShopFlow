apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "medusa.fullname" . }}-setup
  labels:
    {{- include "medusa.labels" . | nindent 4 }}
    app.kubernetes.io/component: setup
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        {{- include "medusa.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: setup
    spec:
      restartPolicy: Never
      containers:
      - name: medusa-setup
        image: "{{ .Values.medusa.image.repository }}:{{ .Values.medusa.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.medusa.image.pullPolicy }}
        resources:
          requests:
            memory: "128Mi"
            cpu: "25m"
          limits:
            memory: "256Mi"
            cpu: "100m"
        workingDir: /app/medusa-store
        command: ["/bin/sh", "-c"]
        args:
          - |
            set -e
            echo "Waiting for Medusa API to be ready..."
            for i in $(seq 1 60); do
              if curl -sf http://{{ include "medusa.fullname" . }}:9000/health > /dev/null 2>&1; then
                echo "API is ready!"
                break
              fi
              echo "Waiting... ($i/60)"
              sleep 5
            done
            
            echo "Creating admin user via Medusa CLI..."
            npx medusa user -e {{ .Values.medusa.adminEmail }} -p {{ .Values.medusa.adminPassword }} || echo "User might already exist"
            
            echo "Seeding database with sample data..."
            npx medusa seed -f ./data/seed.json || echo "Seed might have already run"
            
            echo "Creating additional sample products via API..."
            sleep 10
            
            # Try to login and get token
            TOKEN=$(curl -sf -X POST http://{{ include "medusa.fullname" . }}:9000/admin/auth \
              -H "Content-Type: application/json" \
              -d '{"email":"{{ .Values.medusa.adminEmail }}","password":"{{ .Values.medusa.adminPassword }}"}' \
              2>/dev/null | grep -o '"token":"[^"]*' | cut -d'"' -f4)
            
            if [ -n "$TOKEN" ]; then
              echo "Successfully authenticated! Token obtained."
              echo "Creating additional products..."
              
              # Create T-Shirt
              curl -sf -X POST http://{{ include "medusa.fullname" . }}:9000/admin/products \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $TOKEN" \
                -d '{
                  "title": "Classic T-Shirt",
                  "subtitle": "Comfortable cotton tee",
                  "description": "A soft and comfortable cotton t-shirt perfect for everyday wear",
                  "handle": "classic-tshirt",
                  "status": "published",
                  "options": [{"title": "Size"}],
                  "variants": [
                    {
                      "title": "Small",
                      "prices": [{"currency_code": "usd", "amount": 2999}],
                      "options": [{"value": "S"}],
                      "manage_inventory": false,
                      "inventory_quantity": 100
                    },
                    {
                      "title": "Medium", 
                      "prices": [{"currency_code": "usd", "amount": 2999}],
                      "options": [{"value": "M"}],
                      "manage_inventory": false,
                      "inventory_quantity": 100
                    },
                    {
                      "title": "Large",
                      "prices": [{"currency_code": "usd", "amount": 2999}],
                      "options": [{"value": "L"}],
                      "manage_inventory": false,
                      "inventory_quantity": 100
                    }
                  ]
                }' || echo "Product creation failed"
              
              # Create Coffee Mug
              curl -sf -X POST http://{{ include "medusa.fullname" . }}:9000/admin/products \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $TOKEN" \
                -d '{
                  "title": "Ceramic Coffee Mug",
                  "subtitle": "Start your day right",
                  "description": "Premium ceramic mug perfect for your morning coffee",
                  "handle": "ceramic-mug",
                  "status": "published",
                  "variants": [{
                    "title": "Default",
                    "prices": [{"currency_code": "usd", "amount": 1499}],
                    "manage_inventory": false,
                    "inventory_quantity": 50
                  }]
                }' || echo "Product creation failed"
              
              # Create Hoodie
              curl -sf -X POST http://{{ include "medusa.fullname" . }}:9000/admin/products \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $TOKEN" \
                -d '{
                  "title": "Cozy Hoodie",
                  "subtitle": "Stay warm and stylish",
                  "description": "Super soft fleece hoodie with front pocket",
                  "handle": "cozy-hoodie",
                  "status": "published",
                  "options": [{"title": "Size"}, {"title": "Color"}],
                  "variants": [
                    {
                      "title": "Medium / Black",
                      "prices": [{"currency_code": "usd", "amount": 5999}],
                      "options": [{"value": "M"}, {"value": "Black"}],
                      "manage_inventory": false,
                      "inventory_quantity": 30
                    },
                    {
                      "title": "Large / Black",
                      "prices": [{"currency_code": "usd", "amount": 5999}],
                      "options": [{"value": "L"}, {"value": "Black"}],
                      "manage_inventory": false,
                      "inventory_quantity": 30
                    }
                  ]
                }' || echo "Product creation failed"
              
              echo "✅ Products created successfully!"
            else
              echo "⚠️  Could not authenticate. Products not created."
            fi
            
            echo ""
            echo "================================================"
            echo "✅ Medusa setup completed!"
            echo "================================================"
            echo "Admin Login:"
            echo "  Email: {{ .Values.medusa.adminEmail }}"
            echo "  Password: {{ .Values.medusa.adminPassword }}"
            echo "================================================"
        env:
        {{- range $key, $value := .Values.medusa.env }}
        - name: {{ $key }}
          value: {{ $value | quote }}
        {{- end }}
        {{- if .Values.secrets.createSecret }}
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: {{ include "medusa.fullname" . }}-secret
              key: DATABASE_URL
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: {{ include "medusa.fullname" . }}-secret
              key: REDIS_URL
        {{- end }}
