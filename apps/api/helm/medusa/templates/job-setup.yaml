apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "medusa.fullname" . }}-setup
  labels:
    {{- include "medusa.labels" . | nindent 4 }}
    app.kubernetes.io/component: setup
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        {{- include "medusa.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: setup
    spec:
      restartPolicy: Never
      containers:
      - name: medusa-setup
        image: "{{ .Values.medusa.image.repository }}:{{ .Values.medusa.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.medusa.image.pullPolicy }}
        resources:
          requests:
            memory: "128Mi"
            cpu: "25m"
          limits:
            memory: "256Mi"
            cpu: "100m"
        workingDir: /app/medusa-store
        command: ["/bin/sh", "-c"]
        args:
          - |
            set -e
            echo "Waiting for Medusa API to be ready..."
            for i in $(seq 1 60); do
              if curl -sf http://{{ include "medusa.fullname" . }}:9000/health > /dev/null 2>&1; then
                echo "API is ready!"
                break
              fi
              echo "Waiting... ($i/60)"
              sleep 5
            done
            
            echo "Creating admin user via Medusa CLI..."
            npx medusa user -e {{ .Values.medusa.adminEmail }} -p {{ .Values.medusa.adminPassword }} || echo "User might already exist"
            
            echo "Seeding database with sample data..."
            npx medusa seed -f ./data/seed.json || echo "Seed might have already run"
            
            echo "Creating Publishable API Key directly in database..."
            # Generate a publishable key ID
            PUB_KEY_ID="pk_$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 24 | head -n 1)"
            
            # Insert directly into database
            PGPASSWORD="{{ .Values.postgresql.auth.password }}" psql -h {{ .Release.Name }}-postgresql -U {{ .Values.postgresql.auth.username }} -d {{ .Values.postgresql.auth.database }} -c "
              INSERT INTO publishable_api_key (id, created_at, updated_at, created_by, revoked_by, revoked_at)
              VALUES ('$PUB_KEY_ID', NOW(), NOW(), NULL, NULL, NULL)
              ON CONFLICT (id) DO NOTHING;
            " 2>&1 || echo "⚠️ Could not create API key in database"
            
            if [ $? -eq 0 ]; then
              echo ""
              echo "================================================"
              echo "✅ Medusa setup completed!"
              echo "================================================"
              echo "Admin Login:"
              echo "  Email: {{ .Values.medusa.adminEmail }}"
              echo "  Password: {{ .Values.medusa.adminPassword }}"
              echo ""
              echo "Publishable API Key (use in x-publishable-api-key header):"
              echo "  $PUB_KEY_ID"
              echo ""
              echo "Store API Usage:"
              echo "  curl http://{{ .Release.Name }}:9000/store/products \\"
              echo "    -H \"x-publishable-api-key: $PUB_KEY_ID\""
              echo "================================================"
            else
              echo ""
              echo "================================================"
              echo "✅ Medusa setup completed (partial)!"
              echo "================================================"
              echo "Admin Login:"
              echo "  Email: {{ .Values.medusa.adminEmail }}"
              echo "  Password: {{ .Values.medusa.adminPassword }}"
              echo ""
              echo "⚠️ Please create Publishable API Key manually:"
              echo "  1. Login to admin panel"
              echo "  2. Go to Settings → Developer → Publishable API Keys"
              echo "  3. Create a new key"
              echo "================================================"
            fi
        env:
        {{- range $key, $value := .Values.medusa.env }}
        - name: {{ $key }}
          value: {{ $value | quote }}
        {{- end }}
        {{- if .Values.secrets.createSecret }}
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: {{ include "medusa.fullname" . }}-secret
              key: DATABASE_URL
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: {{ include "medusa.fullname" . }}-secret
              key: REDIS_URL
        {{- end }}
